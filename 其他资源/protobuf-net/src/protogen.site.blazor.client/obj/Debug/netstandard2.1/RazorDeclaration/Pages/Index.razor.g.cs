// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace ProtoBuf.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 2 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using ProtoBuf;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using ProtoBuf.Pages;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\_Imports.razor"
using ProtoBuf.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
using Google.Protobuf.Reflection;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
using ProtoBuf.Reflection;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
using ProtoBuf.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
using System.Text.Json;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/")]
    public partial class Index : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 167 "C:\Users\baoruichang\Desktop\protobuf-net\src\protogen.site.blazor.client\Pages\Index.razor"
      

    bool showMoreOptions = false;
    bool loading = false;

    MonacoEditor protoEditor;

    Error[] errors;

    private GeneratorViewModel model = new GeneratorViewModel();

    private List<CodeFile> codeFiles;

    private CodeFile currentCodeFile;

    private string exceptionMessage;

    protected async Task LoadSample()
    {
        model.ProtoContent = await Http.GetStringAsync("https://raw.githubusercontent.com/google/protobuf/master/src/google/protobuf/descriptor.proto");
        showMoreOptions = false;
    }

    protected async Task LoadProtoWithOptions()
    {

        model.ProtoContent = await Http.GetStringAsync("https://gist.githubusercontent.com/mgravell/c545f903467fd7fa441ad80c5433d331/raw/59e0681069463c016eb06a630991945aa783b90f/configure_protogen.proto");
        showMoreOptions = false;

    }
    protected async Task Generate()
    {
        try
        {
            loading = true;
            codeFiles = null;
            exceptionMessage = null;
            errors = null;
            await protoEditor.ClearErrors();
            StateHasChanged();
            using (var reader = new StringReader(model.ProtoContent))
            {
                var set = new FileDescriptorSet
                {
                    ImportValidator = path => true
                };
                set.Add("my.proto", true, reader);

                set.Process();
                errors = set.GetErrors();
                if (errors.Any())
                {
                    foreach (var error in errors)
                    {
                        await protoEditor.AddError(error.IsError, error.LineNumber, error.LineNumber, error.ColumnNumber, error.ColumnNumber + error.LineContents.Length, error.Message);
                    }
                    return;
                }

                if (model.IsProtogen() && !model.ProtoContent.Contains("import"))
                {
                    ProtobufnetGenerate(set);
                }
                else
                {
                    await ServerSideGenerate();
                }
            }
        }
        catch (Exception e)
        {
            exceptionMessage = "An unhandled exception occured : " + e.Message + ". StackTrace : " + e.StackTrace;
        }
        finally
        {
            loading = false;
        }
    }
    private async Task ServerSideGenerate()
    {
        var response = await Http.PostAsync("/generate",
            new StringContent(JsonSerializer.Serialize(model),System.Text.Encoding.UTF8, "application/json"));
        var content = await response.Content.ReadAsStringAsync();
        if (response.IsSuccessStatusCode)
        {
            using (var output = JsonDocument.Parse(content))
            {
                SetCodeFiles(output.RootElement.EnumerateArray()
                    .Select(j => new CodeFile(
                        j.GetProperty("name").GetString(),
                        j.GetProperty("text").GetString()))
                    .ToList());
            }
        }
        else
        {
            if (content.Contains("Exception"))//did not find a better way for handling exception or error file
            {
                this.exceptionMessage = content;
            }
            else
            {
                using (var output = JsonDocument.Parse(content))
                    errors = Error.Parse(
                        output.RootElement.GetProperty("stdout").GetRawText(),
                        output.RootElement.GetProperty("stderr").GetRawText()
                    );
            }
        }
    }
    private void ProtobufnetGenerate(FileDescriptorSet set)
    {
        var generateResult = model.GetCodeGenerator()
            .Generate(set, model.GetNameNormalizerForConvention(), model.GetOptions())
            .ToList();
        SetCodeFiles(generateResult);

    }

    private void SetCodeFiles(List<CodeFile> files)
    {
        codeFiles = files;
        currentCodeFile = files.FirstOrDefault();
    }


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private HttpClient Http { get; set; }
    }
}
#pragma warning restore 1591
